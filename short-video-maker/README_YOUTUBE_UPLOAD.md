# YouTube Upload API Documentation

## Overview

YouTube upload functionality has been integrated into the short-video-maker project. This allows you to automatically upload generated videos to YouTube using OAuth2 authentication.

## Setup

### 1. Install Dependencies

```bash
npm install
```

The `googleapis` package (v144.0.0) has been added to dependencies.

### 2. Configure Environment Variables

Add the following to your `.env` file:

```bash
# YouTube Upload Configuration
YOUTUBE_CLIENT_SECRET_PATH=D:\Data\00_Personal\YTB\client_secret_550996044521-8luac0vqa8sj0jrpa68oi4lgq30k1nqc.apps.googleusercontent.com.json
```

### 3. Client Secret File

Your YouTube OAuth2 client secret file should be placed at the path specified in `YOUTUBE_CLIENT_SECRET_PATH`. The file structure should look like:

```json
{
  "web": {
    "client_id": "YOUR_CLIENT_ID",
    "client_secret": "YOUR_CLIENT_SECRET",
    "redirect_uris": ["http://localhost:3123/api/youtube/callback"],
    "auth_uri": "https://accounts.google.com/o/oauth2/auth",
    "token_uri": "https://oauth2.googleapis.com/token"
  }
}
```

## Authentication Flow

### Step 1: Generate Authorization URL

**GET** `/api/youtube/auth`

Response:
```json
{
  "authUrl": "https://accounts.google.com/o/oauth2/v2/auth?...",
  "message": "Please visit this URL to authorize YouTube access"
}
```

### Step 2: User Authorization

1. Visit the `authUrl` in a browser
2. Sign in with your Google account
3. Grant permissions to your application
4. You'll be redirected to the callback URL with an authorization code

### Step 3: OAuth Callback (Automatic)

**GET** `/api/youtube/callback?code=AUTHORIZATION_CODE`

This endpoint is automatically called by Google after user authorization.

Response:
```json
{
  "success": true,
  "message": "YouTube authentication successful"
}
```

### Step 4: Check Authentication Status

**GET** `/api/youtube/auth-status`

Response:
```json
{
  "authenticated": true
}
```

## API Endpoints

### 1. Upload Video to YouTube

**POST** `/api/youtube/upload`

Request Body:
```json
{
  "videoId": "cmg123abc456...",
  "metadata": {
    "title": "My Amazing Short Video",
    "description": "This is a video generated by AI",
    "tags": ["shorts", "ai", "viral"],
    "categoryId": "22",
    "privacyStatus": "private"
  },
  "notifySubscribers": false
}
```

Parameters:
- `videoId` (required): Internal video ID from our system
- `metadata.title` (required): Video title (max 100 characters)
- `metadata.description` (required): Video description
- `metadata.tags` (optional): Array of tags
- `metadata.categoryId` (optional): YouTube category ID (default: "22" - People & Blogs)
- `metadata.privacyStatus` (required): "public", "private", or "unlisted"
- `notifySubscribers` (optional): Whether to notify subscribers (default: false)

Response:
```json
{
  "success": true,
  "youtubeVideoId": "dQw4w9WgXcQ",
  "url": "https://www.youtube.com/watch?v=dQw4w9WgXcQ",
  "message": "Video uploaded successfully"
}
```

### 2. Get Upload Status

**GET** `/api/youtube/upload/:videoId/status`

Response:
```json
{
  "videoId": "cmg123abc456...",
  "status": "completed",
  "progress": 100,
  "youtubeVideoId": "dQw4w9WgXcQ",
  "url": "https://www.youtube.com/watch?v=dQw4w9WgXcQ",
  "uploadedAt": "2025-10-12T10:30:00.000Z"
}
```

Status values: `pending`, `uploading`, `processing`, `completed`, `failed`

### 3. Get All Uploads

**GET** `/api/youtube/uploads`

Response:
```json
{
  "uploads": [
    {
      "videoId": "cmg123abc456...",
      "status": "completed",
      "youtubeVideoId": "dQw4w9WgXcQ",
      "url": "https://www.youtube.com/watch?v=dQw4w9WgXcQ"
    }
  ],
  "count": 1
}
```

### 4. Clear Upload Status

**DELETE** `/api/youtube/upload/:videoId/status`

Response:
```json
{
  "success": true,
  "message": "Upload status cleared"
}
```

### 5. Revoke Authentication

**POST** `/api/youtube/revoke`

Response:
```json
{
  "success": true,
  "message": "YouTube authentication revoked"
}
```

### 6. Refresh Access Token

**POST** `/api/youtube/refresh-token`

Response:
```json
{
  "success": true,
  "message": "Access token refreshed"
}
```

## YouTube Video Categories

Common category IDs:
- `1` - Film & Animation
- `2` - Autos & Vehicles
- `10` - Music
- `15` - Pets & Animals
- `17` - Sports
- `20` - Gaming
- `22` - People & Blogs (Default)
- `23` - Comedy
- `24` - Entertainment
- `26` - Howto & Style
- `27` - Education
- `28` - Science & Technology

## N8N Integration Example

### Workflow Steps:

1. **Generate Video** (existing workflow)
   - POST `/api/video/nano-banana` or `/api/video/veo3`
   - Get `videoId` from response

2. **Wait for Video Completion**
   - Poll GET `/api/video/nano-banana/:videoId/status`
   - Wait until `status === "completed"`

3. **Upload to YouTube**
   ```json
   POST /api/youtube/upload
   {
     "videoId": "{{$json.videoId}}",
     "metadata": {
       "title": "{{$json.title}}",
       "description": "{{$json.description}}",
       "tags": ["shorts", "ai"],
       "categoryId": "22",
       "privacyStatus": "private"
     }
   }
   ```

4. **Track Upload Status** (optional)
   - GET `/api/youtube/upload/{{$json.videoId}}/status`

## Token Management

- OAuth tokens are automatically saved to `~/.ai-agents-az-video-generator/youtube-tokens.json`
- Access tokens are automatically refreshed when expired
- Refresh tokens are valid indefinitely until revoked

## Error Handling

Common errors:

1. **Not Authenticated**
```json
{
  "error": "Not authenticated with YouTube",
  "message": "Please authenticate first using /api/youtube/auth"
}
```

2. **Video Not Found**
```json
{
  "error": "Video file not found: /path/to/video.mp4"
}
```

3. **Upload Failed**
```json
{
  "success": false,
  "error": "Upload failed",
  "message": "Detailed error message"
}
```

## File Structure

```
short-video-maker/
├── src/
│   └── youtube-upload/
│       ├── services/
│       │   └── YouTubeUploader.ts      # Core upload logic
│       ├── routes/
│       │   └── youtubeRoutes.ts        # API endpoints
│       └── types/
│           └── youtube.ts              # TypeScript types
├── client_secret.json                  # OAuth2 credentials
└── ~/.ai-agents-az-video-generator/
    └── youtube-tokens.json             # Saved OAuth tokens
```

## Security Notes

1. **Never commit** `client_secret.json` to version control
2. **Never commit** `youtube-tokens.json` to version control
3. Tokens are stored locally and encrypted by the OS
4. Always use `privacyStatus: "private"` for testing
5. Be cautious with `notifySubscribers: true` in production

## Testing

1. Authenticate:
```bash
curl http://localhost:3123/api/youtube/auth
```

2. Visit the returned URL and authorize

3. Upload a test video:
```bash
curl -X POST http://localhost:3123/api/youtube/upload \
  -H "Content-Type: application/json" \
  -d '{
    "videoId": "your_video_id",
    "metadata": {
      "title": "Test Upload",
      "description": "Testing YouTube upload API",
      "privacyStatus": "private"
    }
  }'
```

## Troubleshooting

1. **"Client secret file not found"**
   - Check `YOUTUBE_CLIENT_SECRET_PATH` in `.env`
   - Verify the file exists at the specified path

2. **"Video file not found"**
   - Ensure the video has been generated and saved
   - Check `videoId` is correct
   - Verify video exists in `~/.ai-agents-az-video-generator/videos/`

3. **"Token expired"**
   - Use POST `/api/youtube/refresh-token`
   - Or re-authenticate via `/api/youtube/auth`

4. **OAuth redirect URL mismatch**
   - Ensure redirect URI in Google Console matches: `http://localhost:3123/api/youtube/callback`
   - Update PORT in `.env` if using different port

## Next Steps

1. Run `npm install` to install googleapis
2. Set `YOUTUBE_CLIENT_SECRET_PATH` in your `.env` file
3. Start the server: `npm run dev`
4. Authenticate: Visit `/api/youtube/auth`
5. Upload videos: POST to `/api/youtube/upload`

For N8N integration, see the example workflow in the N8N section above.
